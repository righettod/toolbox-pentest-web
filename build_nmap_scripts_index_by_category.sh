#!/bin/bash
CDIR=$(pwd)
INDEX_FILE="$CDIR/docs/7-NMAP_SCRIPTS_INDEX_BY_CATEGORY.md"
NMAP_REPO="/tmp/nmap"
NMAP_GITHUB="https://github.com/nmap/nmap.git"
NMAP_GITHUB_BASE="https://github.com/nmap/nmap/blob/master/scripts"
echo "[+] Init the index..."
echo "# ðŸ’¼ Index of the Nmap built-in scripts" > $INDEX_FILE
echo "" >> $INDEX_FILE
echo "<!-- markdown-link-check-disable -->" >> $INDEX_FILE
echo "" >> $INDEX_FILE
echo "> **Note**: ðŸ•’ Updated on $(date +'%Y-%m-%d at %T')." >> $INDEX_FILE
echo "" >> $INDEX_FILE
echo "ðŸ¡ [Back to home](README.md)." >> $INDEX_FILE
echo "" >> $INDEX_FILE
echo "[+] Clone nmap GH repo..."
rm -rf $NMAP_REPO 2>/dev/null
git clone --quiet --depth 1 $NMAP_GITHUB $NMAP_REPO
echo "[+] Build the index based on present NSE scripts..."
cd "$NMAP_REPO/scripts"
export CDE='```'

# Initialize index file
echo "[+] Init the category index..."
echo "# ðŸ’¼ Index of the Nmap built-in scripts (by category)" > $INDEX_FILE
echo "" >> $INDEX_FILE
echo "> **Note**: ðŸ•’ Updated on $(date +'%Y-%m-%d at %T')." >> $INDEX_FILE
echo "" >> $INDEX_FILE
echo "ðŸ¡ [Back to home](README.md)." >> $INDEX_FILE
echo "" >> $INDEX_FILE

# Create associative arrays for categories and script details
declare -A script_categories
declare -A script_details

# Process each script
cd "$NMAP_REPO/scripts"
for script in $(ls | sort)
do
    # Extract categories, remove single quotes, and split into lines
    raw_categories=$(sed -n '/^categories = /{s/^categories = {\(.*\)}.*$/\1/p}' $script | tr -d '"' | tr -d "'")
    categories=${raw_categories//,/ }
    for category in $categories
    do
        script_categories[$category]+="${script%%.*} "
    done

    # Extract and truncate the description without space before "..."
    script_descr=$(sed -n '/^description = \[\[/,/\]\]/p' $script | sed '1d;$d' | tr -d '\0' | tr '\n' ' ' | awk '{print substr($0, 1, 97)"..."}')

    # Save script details in an associative array
    script_details[${script%%.*}]="$script_descr | $raw_categories"
done

# Create a sorted array of unique categories
IFS=$'\n' sorted_categories=($(sort <<<"${!script_categories[*]}"))
unset IFS

# Generate Table of Contents
echo "## Categories" >> $INDEX_FILE
for category in "${sorted_categories[@]}"
do
    echo "- [$category](#$category)" >> $INDEX_FILE
done
echo "" >> $INDEX_FILE

# Generate the list of scripts by category
for category in "${sorted_categories[@]}"
do
    echo "## $category" >> $INDEX_FILE
    for script in ${script_categories[$category]}
    do
        echo "### $script" >> $INDEX_FILE
        echo "* ðŸ“ [Source]($NMAP_GITHUB_BASE/$script.nse)" >> $INDEX_FILE
        # Extract script categories for anchor links
        IFS='|' read -r script_description script_cats <<< "${script_details[$script]}"
        script_cats_links=$(echo $script_cats | sed -e 's/, /\n/g' | awk '{print "[#" $1 "](#" $1 ")"}' | paste -sd' ' -)
        echo "* ðŸ“‚ $script_cats_links" >> $INDEX_FILE
        echo "" >> $INDEX_FILE
        echo "$CDE" >> $INDEX_FILE
        echo "$script_description" >> $INDEX_FILE # No space before "..."
        echo "$CDE" >> $INDEX_FILE
        echo "" >> $INDEX_FILE
    done
done

echo "[V] Category index built."
